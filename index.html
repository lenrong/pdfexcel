<script>
    let extractedData = [];
    let tableLayout = []; // Untuk menyimpan layout tabel (baris dan kolom)

    async function convertPDF() {
        const fileInput = document.getElementById('pdfFile');
        if (!fileInput.files.length) {
            alert("Pilih file PDF terlebih dahulu!");
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();
        document.getElementById('status').innerText = "Processing...";

        reader.onload = async function() {
            try {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                extractedData = [];
                tableLayout = []; // Reset layout

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const scale = 2;
                    const viewport = page.getViewport({ scale });

                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    const imageData = canvas.toDataURL("image/png");

                    const { data: { text, words } } = await Tesseract.recognize(imageData, 'eng');

                    // Simpan layout tabel
                    tableLayout.push(words);

                    // Proses teks untuk tabel
                    const row = words.map(word => word.text).join(' ');
                    extractedData.push([row]);
                }

                document.getElementById('status').innerText = "Conversion completed!";
                document.getElementById('downloadExcel').style.display = "block";
                document.getElementById('result').style.display = "block";
                displayResult(extractedData);
            } catch (error) {
                console.error("Error during conversion:", error);
                document.getElementById('status').innerText = "Error during conversion. Check console for details.";
            }
        };

        reader.readAsArrayBuffer(file);
    }

    function displayResult(data) {
        const table = document.getElementById('resultTable');
        table.innerHTML = ""; // Bersihkan tabel sebelumnya

        // Buat tabel berdasarkan layout yang ditemukan oleh OCR
        tableLayout.forEach(rowWords => {
            const tr = document.createElement("tr");
            rowWords.forEach(word => {
                const td = document.createElement("td");
                td.textContent = word.text; // Tempelkan teks sesuai posisi kata
                tr.appendChild(td);
            });
            table.appendChild(tr);
        });
    }

    function downloadExcel() {
        const ws = XLSX.utils.aoa_to_sheet(extractedData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Extracted Data");
        XLSX.writeFile(wb, "Converted.xlsx");
    }
</script>
